/**
 * DSL Runtime å¼€å‘æœåŠ¡å™¨
 * 
 * ğŸ¯ åŸºäº Vite çš„å¼€å‘æœåŠ¡å™¨ï¼Œç”¨äºè¿è¡Œ DSL é¡¹ç›®
 */

import { createServer, type ViteDevServer } from 'vite';
import path from 'path';
import fs from 'fs';
import { createRequire, Module } from 'module';
import { fileURLToPath } from 'url';
import type { DSLProjectConfig } from './loader.js';

// åˆ›å»º require å‡½æ•°ç”¨äºè§£ææ¨¡å—è·¯å¾„
const require = createRequire(import.meta.url);

// ğŸ¯ è·¨å¹³å°å…¼å®¹ï¼šä½¿ç”¨ fileURLToPath æ­£ç¡®å¤„ç† Windows å’Œ Mac/Linux è·¯å¾„
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// dsl-runtime åŒ…çš„æ ¹ç›®å½•
const runtimePackageDir = path.resolve(__dirname, '..');

/**
 * è§£æåŒ…è·¯å¾„ï¼ˆä» pnpm çš„ .pnpm ç›®å½•æˆ– workspace ä¸­ï¼‰
 */
function resolvePackage(packageName: string): string {
  // monorepo æ ¹ç›®å½•
  const monoRepoRoot = path.join(runtimePackageDir, '../..');
  
  // å°è¯•ä» workspace åŒ…è§£æï¼ˆå¦‚ @ai-builder/runtime-rendererï¼‰
  if (packageName.startsWith('@ai-builder/')) {
    const workspacePath = path.join(monoRepoRoot, 'packages', packageName.replace('@ai-builder/', ''));
    if (fs.existsSync(workspacePath)) {
      return workspacePath;
    }
  }
  
  // ä½¿ç”¨ require.resolve è·å–æ¨¡å—çš„å®é™…è·¯å¾„
  try {
    const resolved = require.resolve(packageName + '/package.json', { paths: [runtimePackageDir] });
    return path.dirname(resolved);
  } catch {
    // å¿½ç•¥é”™è¯¯ï¼Œç»§ç»­å°è¯•å…¶ä»–æ–¹å¼
  }
  
  // è¿”å›åŸå§‹åŒ…åï¼Œè®© Vite è‡ªå·±è§£æ
  return packageName;
}

/**
 * ç”Ÿæˆè™šæ‹Ÿå…¥å£æ–‡ä»¶å†…å®¹
 */
function generateEntryContent(config: DSLProjectConfig): string {
  const dslPath = path.join(config.root, config.srcDir).replace(/\\/g, '/');
  const initSqlPath = config.database?.initSql 
    ? path.join(config.root, config.database.initSql).replace(/\\/g, '/')
    : null;

  return `
/**
 * ğŸ¯ Auto-generated by DSL Runtime
 * è¿™æ˜¯ç”± dsl-runtime è‡ªåŠ¨ç”Ÿæˆçš„å…¥å£æ–‡ä»¶
 */

import 'reflect-metadata';
import React from 'react';
import ReactDOM from 'react-dom/client';
import { ConfigProvider, Layout, Menu, Spin, Alert, Avatar, Dropdown, Space } from 'antd';
import { 
  OrderedListOutlined, 
  DatabaseOutlined, 
  SettingOutlined,
  HomeOutlined,
  UserOutlined,
  LogoutOutlined,
} from '@ant-design/icons';
import zhCN from 'antd/locale/zh_CN';

import { 
  createDSLRouter,
  registerComponents,
  getLayeredStats,
  initDatabase,
  getMenuRoutes,
  useNavigate,
  getMergedAppConfig,
  vnodeToReactElement,
} from '@qwe8652591/dsl-core';

import { getAntdComponentMapping } from '@dsl-runtime/antd-components/adapter';

// ğŸ¯ åŠ¨æ€å¯¼å…¥ DSL å®šä¹‰ï¼ˆå¿…é¡»å…ˆå¯¼å…¥ï¼Œè®©è£…é¥°å™¨æ³¨å†Œ metadataï¼‰
import '${dslPath}';

// å¯¼å…¥è·¯ç”±é…ç½®
import { routes } from '${dslPath}/routes';

${initSqlPath ? `import initSqlContent from '${initSqlPath}?raw';` : ''}

// æ³¨å†Œ Antd ç»„ä»¶
registerComponents(getAntdComponentMapping());

// åˆ›å»ºè·¯ç”±
const { router, Provider: AppRouter } = createDSLRouter(routes, {
  fallback: (
    <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', height: '100vh' }}>
      <Spin size="large" tip="åŠ è½½ä¸­..." />
    </div>
  ),
  notFound: (
    <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', height: '100vh' }}>
      <Alert type="warning" message="404 - é¡µé¢ä¸å­˜åœ¨" />
    </div>
  ),
});

// å›¾æ ‡æ˜ å°„
const iconMap: Record<string, React.ReactNode> = {
  OrderedListOutlined: <OrderedListOutlined />,
  DatabaseOutlined: <DatabaseOutlined />,
  SettingOutlined: <SettingOutlined />,
  HomeOutlined: <HomeOutlined />,
};

// ä» CDN åŠ è½½ sql.js
async function loadSqlJsFromCDN(): Promise<any> {
  if ((window as any).initSqlJs) {
    return (window as any).initSqlJs;
  }
  
  return new Promise((resolve, reject) => {
    const script = document.createElement('script');
    script.src = 'https://sql.js.org/dist/sql-wasm.js';
    script.onload = () => {
      if ((window as any).initSqlJs) {
        resolve((window as any).initSqlJs);
      } else {
        reject(new Error('sql.js failed to load'));
      }
    };
    script.onerror = reject;
    document.head.appendChild(script);
  });
}

// ä¾§è¾¹èœå•ç»„ä»¶
function SideMenu({ currentPath }: { currentPath: string }) {
  const navigate = useNavigate();
  const menuRoutes = getMenuRoutes(routes);
  
  const menuItems = menuRoutes.map(route => ({
    key: route.path,
    icon: route.menu?.icon ? iconMap[route.menu.icon] : null,
    label: route.menu?.label || route.title,
  }));
  
  const handleMenuClick = ({ key }: { key: string }) => {
    navigate(key);
  };
  
  return (
    <Menu
      mode="inline"
      selectedKeys={[currentPath]}
      style={{ height: 'calc(100% - 64px)', borderRight: 0 }}
      items={menuItems}
      onClick={handleMenuClick}
    />
  );
}

// è·å–å½“å‰è·¯ç”±çš„æ ‡é¢˜
function getPageTitle(path: string, appName: string): string {
  const route = routes.find(r => {
    if (r.path === path) return true;
    // æ”¯æŒåŠ¨æ€è·¯ç”±åŒ¹é… /orders/:id
    const pattern = r.path.replace(/:[^/]+/g, '[^/]+');
    return new RegExp(\`^\${pattern}$\`).test(path);
  });
  return route?.title || appName;
}

// æ¸²æŸ“ DSL æ’æ§½ç»„ä»¶
function renderSlot(slotComponent: any, props: any = {}): React.ReactNode {
  if (!slotComponent) return null;
  
  // å¦‚æœæ˜¯ DSL ç»„ä»¶å®šä¹‰ï¼Œæ‰§è¡Œ setup å¹¶è½¬æ¢ä¸º React
  if (slotComponent.setup && typeof slotComponent.setup === 'function') {
    try {
      const result = slotComponent.setup(props);
      
      // setup è¿”å›æ¸²æŸ“å‡½æ•°ï¼Œéœ€è¦è°ƒç”¨å®ƒè·å– VNode
      if (typeof result === 'function') {
        const vnode = result();
        if (vnode && typeof vnode === 'object' && 'type' in vnode) {
          return vnodeToReactElement(vnode);
        }
        return vnode;
      }
      
      // å…¼å®¹ï¼šç›´æ¥è¿”å› VNode çš„æƒ…å†µ
      if (result && typeof result === 'object' && 'type' in result) {
        return vnodeToReactElement(result);
      }
      
      return result;
    } catch (e) {
      console.error('[Slot] Failed to render:', slotComponent.meta?.name || slotComponent.name, e);
      return null;
    }
  }
  
  return null;
}

// åº”ç”¨å¸ƒå±€ç»„ä»¶
function AppLayout({ children }: { children: React.ReactNode }) {
  // ğŸ¯ ä» Metadata è·å–åº”ç”¨é…ç½®
  const appConfig = getMergedAppConfig();
  const slots = (appConfig as any).slots || {};
  
  const [currentPath, setCurrentPath] = React.useState(() => {
    return typeof window !== 'undefined' ? window.location.hash.replace('#', '') || '/orders' : '/orders';
  });
  
  // ç›‘å¬è·¯ç”±å˜åŒ–
  React.useEffect(() => {
    const handleHashChange = () => {
      setCurrentPath(window.location.hash.replace('#', '') || '/orders');
    };
    window.addEventListener('hashchange', handleHashChange);
    return () => window.removeEventListener('hashchange', handleHashChange);
  }, []);
  
  const pageTitle = getPageTitle(currentPath, appConfig.name);
  const menuWidth = appConfig.menu?.width || 220;
  const headerHeight = appConfig.header?.height || 56;
  
  // é»˜è®¤ç”¨æˆ·ä¸‹æ‹‰èœå•
  const defaultUserMenu = (
    <Dropdown 
      menu={{ 
        items: [
          { key: 'profile', icon: <UserOutlined />, label: 'ä¸ªäººä¿¡æ¯' },
          { key: 'settings', icon: <SettingOutlined />, label: 'è®¾ç½®' },
          { type: 'divider' as const },
          { key: 'logout', icon: <LogoutOutlined />, label: 'é€€å‡ºç™»å½•', danger: true },
        ]
      }} 
      placement="bottomRight"
    >
      <Space style={{ cursor: 'pointer' }}>
        <Avatar icon={<UserOutlined />} style={{ backgroundColor: appConfig.theme?.primaryColor || '#1890ff' }} />
        <span>ç®¡ç†å‘˜</span>
      </Space>
    </Dropdown>
  );
  
  // æ¸²æŸ“å¤´éƒ¨å³ä¾§
  const headerRightContent = slots.headerRight 
    ? renderSlot(slots.headerRight, { pageTitle, currentPath })
    : (appConfig.header?.showUser !== false ? defaultUserMenu : null);
  
  return (
    <Layout style={{ minHeight: '100vh' }}>
      <Layout.Sider 
        width={menuWidth} 
        theme="light" 
        style={{ 
          boxShadow: '2px 0 8px rgba(0,0,0,0.06)',
          position: 'fixed',
          left: 0,
          top: 0,
          bottom: 0,
          zIndex: 100,
          display: 'flex',
          flexDirection: 'column',
        }}
      >
        {/* ä¾§è¾¹æ å¤´éƒ¨ */}
        {slots.sidebarHeader ? (
          renderSlot(slots.sidebarHeader, { currentPath })
        ) : (
          <div style={{ 
            height: 64, 
            display: 'flex', 
            alignItems: 'center', 
            justifyContent: 'center',
            borderBottom: '1px solid #f0f0f0',
            fontWeight: 600,
            fontSize: 16,
          }}>
            {appConfig.logo || 'ğŸš€'} {appConfig.name}
          </div>
        )}
        
        {/* èœå• */}
        <div style={{ flex: 1, overflow: 'auto' }}>
          <SideMenu currentPath={currentPath} />
        </div>
        
        {/* ä¾§è¾¹æ åº•éƒ¨ */}
        {slots.sidebarFooter && renderSlot(slots.sidebarFooter, { currentPath })}
      </Layout.Sider>
      
      <Layout style={{ marginLeft: menuWidth }}>
        {/* å¤´éƒ¨æ  */}
        <Layout.Header style={{ 
          background: '#fff', 
          padding: '0 24px', 
          display: 'flex', 
          alignItems: 'center', 
          justifyContent: 'space-between',
          borderBottom: '1px solid #f0f0f0',
          position: 'sticky',
          top: 0,
          zIndex: 99,
          height: headerHeight,
          lineHeight: \`\${headerHeight}px\`,
        }}>
          {/* å¤´éƒ¨å·¦ä¾§ */}
          {slots.headerLeft ? (
            renderSlot(slots.headerLeft, { pageTitle, currentPath })
          ) : (
            <h2 style={{ margin: 0, fontSize: 18, fontWeight: 500 }}>
              {pageTitle}
            </h2>
          )}
          
          {/* å¤´éƒ¨å³ä¾§ */}
          {headerRightContent}
        </Layout.Header>
        
        {/* å†…å®¹åŒº */}
        <Layout.Content style={{ background: '#fff' }}>
          {children}
        </Layout.Content>
      </Layout>
    </Layout>
  );
}

// åº”ç”¨ç»„ä»¶
function App() {
  const [ready, setReady] = React.useState(false);
  const [error, setError] = React.useState<Error | null>(null);

  React.useEffect(() => {
    async function init() {
      try {
        // åŠ¨æ€åŠ è½½ sql.jsï¼ˆä» CDNï¼‰
        const initSqlJs = await loadSqlJsFromCDN();
        
        // åˆå§‹åŒ–æ•°æ®åº“ï¼ˆä½¿ç”¨é…ç½®ï¼‰
        await initDatabase({
          type: 'sqlite',
          sqlJsModule: initSqlJs,
          persistKey: '${config.database?.persistKey || 'dsl-app-db'}',
          ${initSqlPath ? `mockDataSQL: initSqlContent,
          loadMockData: true,
          checkTable: '${config.database?.checkTable || ''}',` : ''}
          debug: ${config.database?.debug ?? false},
        });
        
        // æ‰“å° DSL ç»Ÿè®¡
        const stats = getLayeredStats();
        console.log('ğŸ“Š DSL Metadata Statistics:', stats);
        
        setReady(true);
      } catch (err) {
        console.error('Failed to initialize:', err);
        setError(err as Error);
      }
    }
    
    init();
  }, []);

  if (error) {
    return (
      <ConfigProvider locale={zhCN}>
        <div style={{ padding: 40 }}>
          <Alert 
            type="error" 
            message="åˆå§‹åŒ–å¤±è´¥" 
            description={<pre style={{ margin: 0 }}>{error.message}</pre>}
            showIcon
          />
        </div>
      </ConfigProvider>
    );
  }

  if (!ready) {
    return (
      <ConfigProvider locale={zhCN}>
        <div style={{ 
          display: 'flex', 
          justifyContent: 'center', 
          alignItems: 'center', 
          height: '100vh',
          flexDirection: 'column',
          gap: 16,
        }}>
          <Spin size="large" />
          <span>æ­£åœ¨åˆå§‹åŒ–åº”ç”¨...</span>
        </div>
      </ConfigProvider>
    );
  }

  return (
    <ConfigProvider locale={zhCN}>
      <AppLayout>
        <AppRouter />
      </AppLayout>
    </ConfigProvider>
  );
}

// æŒ‚è½½åº”ç”¨
const root = ReactDOM.createRoot(document.getElementById('root')!);
root.render(<App />);
`;
}

/**
 * ç”Ÿæˆ HTML æ¨¡æ¿
 */
function generateHtmlTemplate(): string {
  return `<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DSL Runtime</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
  </style>
  <!-- sql.js from CDN -->
  <script src="https://sql.js.org/dist/sql-wasm.js"></script>
</head>
<body>
  <div id="root"></div>
  <script type="module" src="/@dsl-entry"></script>
</body>
</html>`;
}

/**
 * åˆ›å»ºå¼€å‘æœåŠ¡å™¨
 */
export async function createDevServer(config: DSLProjectConfig): Promise<ViteDevServer> {
  const htmlTemplate = generateHtmlTemplate();
  
  // è·å– dsl-runtime åŒ…çš„è·¯å¾„ï¼ˆä½¿ç”¨è·¨å¹³å°å…¼å®¹çš„æ–¹å¼ï¼‰
  const runtimePath = __dirname;
  
  // DSL é¡¹ç›®è·¯å¾„
  const dslPath = path.join(config.root, config.srcDir).replace(/\\/g, '/');
  const initSqlPath = config.database?.initSql 
    ? path.join(config.root, config.database.initSql).replace(/\\/g, '/')
    : null;
  
  console.log(`ğŸ“ Using runtime entry from dsl-runtime package`);
  console.log(`   Runtime path: ${runtimePath}`);

  const server = await createServer({
    // ä½¿ç”¨ DSL é¡¹ç›®ä½œä¸ºæ ¹ç›®å½•
    root: config.root,
    
    server: {
      port: config.server?.port || 3000,
      host: config.server?.host || 'localhost',
      // ğŸ¯ å…è®¸è®¿é—® dsl-runtime åŒ…çš„æ–‡ä»¶
      fs: {
        allow: [config.root, runtimePackageDir, path.join(runtimePackageDir, '..')]
      }
    },
    
    plugins: [
      // HTML å…¥å£æ’ä»¶
      {
        name: 'dsl-runtime-html',
        
        configureServer(server) {
          // æ‹¦æˆªæ ¹è·¯å¾„ï¼Œè¿”å› HTML
          server.middlewares.use((req, res, next) => {
            if (req.url === '/' || req.url === '/index.html') {
              res.setHeader('Content-Type', 'text/html');
              res.end(htmlTemplate);
              return;
            }
            next();
          });
        },
      },
      
      // ğŸ¯ è™šæ‹Ÿå…¥å£æ¨¡å—æ’ä»¶
      {
        name: 'dsl-runtime-entry',
        enforce: 'pre' as const,
        
        resolveId(id) {
          if (id === '/@dsl-entry') {
            return '\0dsl-entry';
          }
          // è§£æè¿è¡Œæ—¶å…¥å£åˆ«å
          if (id === '@dsl-runtime/entry') {
            // runtimePath æŒ‡å‘ dist ç›®å½•ï¼Œruntime-entry.tsx åœ¨ src ç›®å½•
            return path.join(runtimePath, '../src/runtime-entry.tsx');
          }
        },
        
        load(id) {
          if (id === '\0dsl-entry') {
            // ç”Ÿæˆå…¥å£ä»£ç  - ä½¿ç”¨åˆ«åè€Œä¸æ˜¯ç»å¯¹è·¯å¾„
            return `
import { render } from '@dsl-runtime/entry';

// å¯¼å…¥ DSL å®šä¹‰
import '${dslPath}';

// å¯¼å…¥è·¯ç”±é…ç½®
import { routes } from '${dslPath}/routes';

${initSqlPath ? `import initSqlContent from '${initSqlPath}?raw';` : 'const initSqlContent = undefined;'}

// è®¾ç½®æ•°æ®åº“é…ç½®
window.__DATABASE_CONFIG__ = ${JSON.stringify({
              persistKey: config.database?.persistKey || config.name || 'dsl-app',
              checkTable: config.database?.checkTable,
            })};

// æ¸²æŸ“åº”ç”¨
render(routes, initSqlContent);
`;
          }
        },
      },
      
      // sql.js æ‹¦æˆªæ’ä»¶ï¼ˆä» CDN åŠ è½½ï¼Œä¸æ‰“åŒ…ï¼‰
      {
        name: 'dsl-runtime-sql-js',
        enforce: 'pre' as const,
        
        resolveId(id) {
          if (id === 'sql.js') {
            return '\0sql-js-stub';
          }
        },
        
        load(id) {
          if (id === '\0sql-js-stub') {
            return `
              export default function() {
                throw new Error('sql.js should be loaded from CDN');
              }
            `;
          }
        },
      },
    ],
    
    resolve: {
      alias: {
        '@': path.join(config.root, 'src'),
        // sql.js ä» CDN åŠ è½½ï¼Œè¿”å›ç©ºæ¨¡å—
        'sql.js': path.join(runtimePath, '../empty-module.js'),
        
        // ğŸ¯ è¿è¡Œæ—¶ä¾èµ–ä» dsl-runtime åŒ…è§£æ
        'react': resolvePackage('react'),
        'react-dom': resolvePackage('react-dom'),
        'react-router-dom': resolvePackage('react-router-dom'),
        'antd': resolvePackage('antd'),
        '@ant-design/icons': resolvePackage('@ant-design/icons'),
        'reflect-metadata': resolvePackage('reflect-metadata'),
        
        // ğŸ¯ AI Builder åŒ…ä» workspace è§£æ
        '@ai-builder/runtime-renderer': resolvePackage('@ai-builder/runtime-renderer'),
        '@qwe8652591/dsl-core': resolvePackage('@qwe8652591/dsl-core'),
        '@qwe8652591/std-ui': resolvePackage('@qwe8652591/std-ui'),
      },
      // ç¡®ä¿è¿è¡Œæ—¶ä¾èµ–ä¸ä¼šè¢«é‡å¤åŠ è½½
      dedupe: ['react', 'react-dom', 'react-router-dom', 'antd', '@ant-design/icons'],
    },
    
    optimizeDeps: {
      // é¢„æ„å»ºè¿™äº›ä¾èµ–ï¼ˆåŒ…æ‹¬ dayjs æ’ä»¶ï¼Œè§£å†³ ESM/CJS å…¼å®¹é—®é¢˜ï¼‰
      include: [
        'react', 
        'react-dom', 
        'react-router-dom', 
        'antd', 
        '@ant-design/icons',
        'dayjs',
        'dayjs/plugin/weekday',
        'dayjs/plugin/localeData',
        'dayjs/plugin/weekOfYear',
        'dayjs/plugin/weekYear',
        'dayjs/plugin/advancedFormat',
        'dayjs/plugin/customParseFormat',
      ],
      // æ’é™¤ sql.jsï¼ˆä» CDN åŠ è½½ï¼‰
      exclude: ['sql.js'],
      // åªæ‰«æ DSL ç›®å½•
      entries: [path.join(config.root, config.srcDir, '**/*.{ts,tsx}')],
    },
    
    esbuild: {
      jsx: 'automatic',
      jsxImportSource: 'react',
    },
  });

  return server;
}
