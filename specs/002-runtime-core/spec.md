# 功能规范: @ai-builder/runtime 核心包

**特性分支**: `002-runtime-core`
**创建日期**: 2025-12-07
**状态**: 草稿
**输入**: 用户描述: "实现 @ai-builder/runtime 核心包，提供内存实现以支持可仿真优先的开发"

## 用户场景与测试 *(必填)*

### 用户故事 1 - 可仿真的业务逻辑 (优先级: P1)

作为一名开发者，我希望在不设置数据库的测试环境中运行我的业务逻辑服务，以便快速验证逻辑。

**优先级理由**: "可仿真优先" 的核心价值主张。支持快速 TDD 循环。

**独立测试**: 实例化一个带有 InMemoryRepo 的服务，执行保存数据的方法，然后验证数据是否存在于仓储中。

**验收场景**:

1. **给定** 一个注入了 `Repo<User>` 的领域服务，**当** 我调用保存用户的方法时，**那么** 我可以立即从仓储中取回该用户。
2. **给定** 一个内存仓储 (InMemoryRepo)，**当** 我保存一个实体时，**那么** 它会生成 ID（如果缺失）并存储它。
3. **给定** 一个包含数据的内存仓储，**当** 我使用条件调用 `findPage` 时，**那么** 它返回正确的分页结果。

---

### 用户故事 2 - 高精度计算 (优先级: P1)

作为一名开发者，我希望使用 `Decimal` 进行财务计算，以便避免浮点数误差。

**优先级理由**: 对于业务应用（金额、数量）至关重要。

**独立测试**: 使用 Decimal 实现验证 `0.1 + 0.2` 精确等于 `0.3`。

**验收场景**:

1. **给定** 两个 Decimal 值 0.1 和 0.2，**当** 我将它们相加时，**那么** 结果是 0.3 (而不是 0.30000000000000004)。
2. **给定** 一个 Decimal 值，**当** 我将其序列化为字符串/JSON 时，**那么** 它保留精度。

---

### 用户故事 3 - 事件驱动流程 (优先级: P2)

作为一名开发者，我希望发布领域事件并在同一进程中由订阅者处理，以便实现解耦逻辑。

**优先级理由**: 支持 MDA 中定义的 "副作用" 和解耦架构。

**独立测试**: 发布一个事件并验证订阅者回调被调用。

**验收场景**:

1. **给定** 一个已注册的订阅者，**当** 通过 `EventBus` 发布事件时，**那么** 订阅者接收到事件负载。
2. **给定** 多个订阅者，**当** 发布一个事件时，**那么** 所有订阅者都会收到通知。
3. **给定** 一个异步订阅者，**当** 发布一个事件时，**那么** 总线正确处理异步执行。

---

### 用户故事 4 - 安全上下文传播 (优先级: P2)

作为一名开发者，我希望在服务层的任何位置访问当前用户和租户 ID，以便实现多租户逻辑和审计日志。

**优先级理由**: 对于任何实际应用（认证/授权）都是关键的。

**独立测试**: 在 "请求" 中设置上下文，调用深层函数，并验证它可以访问上下文。

**验收场景**:

1. **给定** 初始化为用户 A 的 `SecurityContext`，**当** 我在调用栈深处访问 `SecurityContext.getUserId()` 时，**那么** 它返回用户 A 的 ID。
2. **给定** 异步操作，**当** 上下文跨越 await 调用传递时，**那么** 它保持可访问 (AsyncLocalStorage)。

---

### 用户故事 5 - 扩展钩子 (优先级: P3)

作为一名开发者，我希望在仓储操作前后注入逻辑，以便实现横切关注点（如日志或软删除）。

**优先级理由**: 框架的可扩展性。

**独立测试**: 注册一个 'before save' 钩子，并验证它在实体存储之前运行。

**验收场景**:

1. **给定** 一个修改数据的 'before save' 钩子，**当** 调用 `repo.save()` 时，**那么** 修改后的数据被存储。
2. **给定** 一个抛出错误的钩子，**当** 操作被触发时，**那么** 操作中止且错误向上传播。

## 需求 *(必填)*

### 功能需求

**Decimal (高精度数值)**
- **FR-001**: 系统必须提供 `Decimal` 实现（封装 `decimal.js-light` 或 `big.js` 等库），满足 DSL 接口要求。
- **FR-002**: 系统必须支持任意精度的基本算术运算（加、减、乘、除）和比较（等于、大于、小于）。

**Repository (仓储)**
- **FR-003**: 系统必须提供实现 `Repo<T>` 的 `InMemoryRepo<T>`。
- **FR-004**: `InMemoryRepo` 必须支持 `save`（创建/更新）、`findById`、`delete` 和 `findPage`（简单过滤）。
- **FR-005**: 系统必须提供一种机制 (`RepoFactory`) 为特定实体实例化仓储。

**Event Bus (事件总线)**
- **FR-006**: 系统必须提供实现 `EventBus` 的 `LocalEventBus`。
- **FR-007**: `LocalEventBus` 必须支持通配符订阅（可选但推荐）或精确主题匹配。

**Hooks (钩子)**
- **FR-008**: 系统必须提供 `HookRegistry` 或类似机制来管理钩子。
- **FR-009**: 系统必须在目标动作之前执行 `before` 钩子，如果钩子失败则中止。
- **FR-010**: 系统必须在目标动作之后执行 `after` 钩子。

**Security (安全)**
- **FR-011**: 系统必须使用 Node.js `AsyncLocalStorage` 提供 `ThreadLocalSecurityContext`。
- **FR-012**: 系统必须允许在 "请求" 或 "仿真范围" 开始时设置上下文。

### 边缘情况
- **EC-001**: 如果在请求范围之外访问 `SecurityContext` 会发生什么？（应抛出异常或返回 null/guest）。
- **EC-002**: 如果 `InMemoryRepo` 耗尽内存会发生什么？（对于仿真来说是可接受的限制）。
- **EC-003**: `InMemoryRepo` 中的并发性？（Node.js 是单线程的，但如果操作让出控制权，应考虑 Map 修改的异步竞争条件）。

## 成功标准 *(必填)*

### 可测量的结果

- **SC-001**: `@ai-builder/dsl` 中定义的 100% 接口（原语）在 `@ai-builder/runtime` 中都有具体实现。
- **SC-002**: 复杂的集成测试（Service -> Repo -> Event）在内存中运行时间低于 100ms。
- **SC-003**: `Decimal` 计算通过所有精度测试（例如通过标准合规性套件或定义的测试向量）。
- **SC-004**: 默认测试套件零外部数据库依赖（Docker, Postgres 等）。
